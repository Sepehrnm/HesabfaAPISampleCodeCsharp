@page
@model HesabfaAPISampleCode.Pages.Accounting.GetModel
@{
    ViewData["Title"] = "دریافت سند حسابداری";
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="form-group" style="width:100%;">
                    <label for="number" class="form-label">شماره سند مورد نظر</label>
                    <input id="number" class="form-control" name="number" />
                </div>
                <br />
                <div class="d-flex align-items-center justify-content-center">
                    <button type="button" class="btn btn-primary submitButton">نمایش</button>
                </div>
                <div id="simple-treeview"></div>
            </div>
        </div>
    </div>
}

<script>
    $(".submitButton").on("click", () => {
        fetch("/api/Document/Get", {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify($("#number").val())
        })
            .then(response => {
                return response.json();
            })
            .then(data => {
                $('#simple-treeview').dxTreeList({
                    dataSource: [data],
                    keyExpr: "Id",
                    rtlEnabled: true,
                    columns: [
                        {
                            dataField: 'Number',
                            caption: 'شماره سند',
                        },
                        {
                            dataField: 'Reference',
                            caption: 'ارجاع'
                        },
                        {
                            dataField: 'Date',
                            caption: 'تاریخ'
                        },
                        {
                            dataField: 'Description',
                            caption: 'توضیحات',
                            minWidth: 200,
                        },
                        {
                            dataField: 'Project',
                            caption: 'پروژه'
                        },
                        {
                            dataField: 'Debit',
                            caption: 'بدهکار'
                        },
                        {
                            dataField: 'Credit',
                            caption: 'بستانکار'
                        },
                        {
                            dataField: 'Status',
                            caption: 'وضعیت سند'
                        },
                        {
                            dataField: 'Transactions',
                            caption: 'تراکنش ها',
                            cellTemplate: function (container, options) {
                                var transactions = options.data.Transactions;
                                var div = $('<div>').addClass('transaction-container');

                                transactions.forEach(function (transaction) {
                                    var accountPath = transaction.AccountPath;
                                    var amount = transaction.Amount;
                                    var cashCode = transaction.CashCode;
                                    var bankCode = transaction.BankCode;
                                    var contactCode = transaction.ContactCode;
                                    var currency = transaction.Currency;
                                    var currencyAmount = transaction.CurrencyAmount;
                                    var description = transaction.Description;
                                    var pettyCashCode = transaction.PettyCashCode;
                                    var info = transaction.Info;

                                    var transactionInfo = $('<div>').addClass('transaction-info');
                                    $('<div>').text('حساب: ' + accountPath).appendTo(transactionInfo);
                                    $('<div>').text('مبلغ: ' + amount).appendTo(transactionInfo);
                                    $('<div>').text('کد صندوق: ' + cashCode).appendTo(transactionInfo);
                                    $('<div>').text('کد بانک: ' + bankCode).appendTo(transactionInfo);
                                    $('<div>').text('کد شخص: ' + contactCode).appendTo(transactionInfo);
                                    $('<div>').text('واحد پول: ' + currency).appendTo(transactionInfo);
                                    $('<div>').text('مبلغ در صورت چند ارزی بودن: ' + currencyAmount).appendTo(transactionInfo);
                                    $('<div>').text('توضیحات: ' + description).appendTo(transactionInfo);
                                    $('<div>').text('کد تنخواه گردان: ' + pettyCashCode).appendTo(transactionInfo);
                                    $('<div>').text('اطلاعات اضافه: ' + info).appendTo(transactionInfo);

                                    transactionInfo.appendTo(div);
                                });

                                div.appendTo(container);
                            }
                        }
                    ],
                    columnAutoWidth: true,
                })
            })
            .catch(error => console.error('Error Occured.', error));
    })
</script>